# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - Kalshi-Data-Ingestor

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Optional: catch dependency/build issues early
      - name: Create and Start virtual environment and Install dependencies
        run: |
          python -m venv antenv
          source antenv/bin/activate
          pip install -r requirements.txt

      # Exclude antenv + env files from artifact; Oryx builds on App Service if SCM_DO_BUILD_DURING_DEPLOYMENT=true
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            .
            !antenv/
            !.env
            !.env.*
            !configs/env/*.env
            !configs/env/*.env.example

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: ./artifact

      # This step requires AZURE_CREDENTIALS to contain the full JSON from:
      # az ad sp create-for-rbac --sdk-auth
      # (must include clientId, clientSecret, tenantId, subscriptionId)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Front Door Standard is configured
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -euo pipefail

            az account set --subscription "179a1c0b-5228-4f8e-904d-c6bb1072f1eb"

            RESOURCE_GROUP="liv"
            APP_NAME="Kalshi-Data-Ingestor"
            FD_PROFILE="kalshi-fd"
            FD_ENDPOINT="kalshi-ingestor"
            ORIGIN_GROUP="kalshi-og"
            ORIGIN_NAME="kalshi-origin"
            ROUTE_NAME="route1"

            ORIGIN_HOST="$(az webapp show -g "$RESOURCE_GROUP" -n "$APP_NAME" --query defaultHostName -o tsv)"

            if ! az afd profile show -g "$RESOURCE_GROUP" -n "$FD_PROFILE" >/dev/null 2>&1; then
              az afd profile create -g "$RESOURCE_GROUP" -n "$FD_PROFILE" --sku Standard_AzureFrontDoor
            fi

            if ! az afd endpoint show -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" -n "$FD_ENDPOINT" >/dev/null 2>&1; then
              az afd endpoint create -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" -n "$FD_ENDPOINT" --enabled-state Enabled
            fi

            if ! az afd origin-group show -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" -n "$ORIGIN_GROUP" >/dev/null 2>&1; then
              az afd origin-group create -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" -n "$ORIGIN_GROUP" \
                --probe-path "/" --probe-request-type GET --probe-protocol Https --probe-interval-in-seconds 120 \
                --sample-size 4 --successful-samples-required 3
            fi

            if ! az afd origin show -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" --origin-group-name "$ORIGIN_GROUP" -n "$ORIGIN_NAME" >/dev/null 2>&1; then
              az afd origin create -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" --origin-group-name "$ORIGIN_GROUP" \
                -n "$ORIGIN_NAME" \
                --host-name "$ORIGIN_HOST" \
                --origin-host-header "$ORIGIN_HOST" \
                --priority 1 --weight 1000 \
                --enabled-state Enabled
            else
              # Keep the origin host in sync if the app default hostname changes.
              az afd origin update -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" --origin-group-name "$ORIGIN_GROUP" \
                -n "$ORIGIN_NAME" \
                --host-name "$ORIGIN_HOST" \
                --origin-host-header "$ORIGIN_HOST"
            fi

            if ! az afd route show -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" --endpoint-name "$FD_ENDPOINT" -n "$ROUTE_NAME" >/dev/null 2>&1; then
              az afd route create -g "$RESOURCE_GROUP" --profile-name "$FD_PROFILE" --endpoint-name "$FD_ENDPOINT" \
                -n "$ROUTE_NAME" \
                --origin-group "$ORIGIN_GROUP" \
                --https-redirect Enabled \
                --supported-protocols Http Https \
                --patterns-to-match "/*" \
                --link-to-default-domain Enabled
            fi

      - name: Configure app settings
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -euo pipefail

            az account set --subscription "179a1c0b-5228-4f8e-904d-c6bb1072f1eb"

            RG="liv"
            APP="Kalshi-Data-Ingestor"

            EXISTING_SECRET="$(az webapp config appsettings list \
              --resource-group "$RG" \
              --name "$APP" \
              --query "[?name=='WEB_PORTAL_SECRET_KEY'].value | [0]" \
              -o tsv)"

            if [ -z "$EXISTING_SECRET" ]; then
              SECRET="$(python -c 'import secrets; print(secrets.token_urlsafe(48))')"
            else
              SECRET="$EXISTING_SECRET"
            fi

            az webapp config appsettings set \
              --resource-group "$RG" \
              --name "$APP" \
              --settings \
                WEB_PORTAL_SECRET_KEY="$SECRET" \
                WEB_PORTAL_TRUST_PROXY=1 \
                WEB_PORTAL_COOKIE_SAMESITE=None \
                WEB_PORTAL_STATIC_CACHE_MAX_AGE_SEC=3600 \
                WEB_PORTAL_COOKIE_SECURE=1

            # Set the Linux startup command (App Service -> appCommandLine)
            # Use APP_PATH so it works regardless of cwd, matching Oryx-style invocation.
            az webapp config set \
              --resource-group "$RG" \
              --name "$APP" \
              --generic-configurations '{"appCommandLine":"bash -lc \"${APP_PATH}/scripts/start_kalshi_appservice.sh\""}'

            az webapp restart --resource-group "$RG" --name "$APP"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: "Kalshi-Data-Ingestor"
          slot-name: "Production"
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_8A914FC12C584EAEAAED9C60384BF3DD }}
          package: ./artifact
